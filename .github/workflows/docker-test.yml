name: Docker Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  docker-test:
    name: Test in Docker (Rocky Linux)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
        include:
          - platform: linux/amd64
            tag: amd64
          - platform: linux/arm64
            tag: arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64,amd64

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: ${{ matrix.platform }}
        load: true
        tags: golang-htcondor:test-${{ matrix.tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Run tests in Docker
      run: |
        docker run --rm --platform ${{ matrix.platform }} \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          golang-htcondor:test-${{ matrix.tag }} \
          go test -v ./...

    - name: Run build in Docker
      run: |
        docker run --rm --platform ${{ matrix.platform }} \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          golang-htcondor:test-${{ matrix.tag }} \
          /bin/sh -c "git config --global --add safe.directory /workspace && go build -v ./...

  docker-integration-test:
    name: Integration Test in Docker
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        load: true
        tags: golang-htcondor:integration-test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Run integration tests with HTCondor
      run: |
        docker run --rm --privileged \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          golang-htcondor:integration-test \
          /bin/bash -c "
            # Run integration tests
            go test -v -tags=integration -timeout=10m ./httpserver/
          "

  docker-verify-env:
    name: Verify Docker Environment
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker image
      run: docker build -t golang-htcondor:verify .

    - name: Verify Go installation
      run: |
        docker run --rm golang-htcondor:verify go version

    - name: Verify HTCondor installation
      run: |
        docker run --rm golang-htcondor:verify condor_version

    - name: Verify development tools
      run: |
        docker run --rm golang-htcondor:verify /bin/bash -c "
          echo 'Checking gopls...'
          gopls version
          echo 'Checking delve...'
          dlv version
          echo 'Checking staticcheck...'
          staticcheck -version
        "

    - name: Test module download
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          golang-htcondor:verify \
          go mod download
